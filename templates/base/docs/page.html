{% extends "base/docs.html" %}

{% macro next_page_link(permalink, title) %}
    <a
        class="docs__related-pages__link docs__related-pages__link--next"
        href="{{ permalink }}"
    ><span class="docs__related-pages__link__text">{{ title }}</span></a>
{% endmacro %}

{% macro previous_page_link(permalink, title) %}
    <a
        class="docs__related-pages__link docs__related-pages__link--prev"
        href="{{ permalink }}"
    ><span class="docs__related-pages__link__text">{{ title }}</span></a>
{% endmacro %}

{% block docs_content %}
    <div class="docs__content">
        <div class="formatted-text">
            <h1 class="docs__title">
                {{ page.title }}
            </h1>
            {{ page.content | safe }}
        </div>
        <div class="docs__related-pages">
            {% if page.lower %}
                {{ self::previous_page_link(permalink=page.lower.permalink, title=page.lower.title) }}
            {% else %}
                {% if section %}
                    {% set ancestor_section = get_section(path=page.ancestors[2]) %}
                    {% set docs_section = get_section(path=page.ancestors[1]) %}
                    {% set previous_section = false %}

                    {% for subsection in docs_section.subsections %}
                        {% set subsection = get_section(path=subsection) %}

                        {% if subsection.permalink == ancestor_section.permalink %}
                           {% break %}
                        {% endif %}

                        {% set_global previous_section = subsection %}
                    {% endfor %}
                    {% if previous_section %}
                        {% for subpage in previous_section.pages %}
                            {% if loop.last %}
                                {{ self::previous_page_link(permalink=subpage.permalink, title=subpage.title) }}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
            {% endif %}
            {% if page.higher %}
                {{ self::next_page_link(permalink=page.higher.permalink, title=page.higher.title) }}
            {% else %}
                {% if section %}
                    {% set ancestor_section = get_section(path=page.ancestors[2]) %}
                    {% set docs_section = get_section(path=page.ancestors[1]) %}
                    {% set use_next_section = false %}

                    {% for subsection in docs_section.subsections %}
                        {% set subsection = get_section(path=subsection) %}
                        {% if use_next_section %}
                            {% for subpage in subsection.pages %}
                                {{ self::next_page_link(permalink=subpage.permalink, title=subpage.title) }}
                                {% break %}
                            {% endfor %}
                            {% break %}
                        {% endif %}

                        {% if subsection.permalink == ancestor_section.permalink %}
                            {% set_global use_next_section = true %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endif %}
        </div>
    </div>
    <nav class="page__nav">
        {% for header in page.toc %}
            <div class="page__item">
                <a
                    href="{{ header.permalink }}"
                    class="page__link"
                >
                    {{ header.title }}
                </a>
            </div>
        {% endfor %}
    </nav>

{% endblock docs_content %}
